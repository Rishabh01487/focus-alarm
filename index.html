<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Focus Alarm</title>
    <meta name="theme-color" content="#e8f4f8">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f8fdff 0%, #e8f4f8 100%);
            color: #2c3e50;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        /* Alarm Active State */
        body.alarm-active {
            background: linear-gradient(135deg, #fff0f0 0%, #ffe8e8 100%);
            animation: gentle-pulse 1s infinite;
        }
        
        @keyframes gentle-pulse {
            0% { background: linear-gradient(135deg, #fff0f0 0%, #ffe8e8 100%); }
            50% { background: linear-gradient(135deg, #ffe8e8 0%, #ffdfdf 100%); }
            100% { background: linear-gradient(135deg, #fff0f0 0%, #ffe8e8 100%); }
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Header */
        header {
            text-align: center;
            padding: 30px 20px;
            background: white;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(70, 130, 180, 0.1);
            border: 2px solid #e3f2fd;
            position: relative;
        }
        
        body.alarm-active header {
            border-color: #ff6b6b;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.15);
        }
        
        h1 {
            color: #4682b4;
            margin-bottom: 10px;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        /* Alarm Status */
        .alarm-status {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 16px;
            margin: 25px 0;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 2px solid #e1ecf4;
        }
        
        body.alarm-active .alarm-status {
            background: #fff0f0;
            border-color: #ffd6d6;
        }
        
        .alarm-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }
        
        .alarm-indicator.ringing {
            background: #ff6b6b;
            animation: soft-pulse 0.5s infinite;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
        }
        
        @keyframes soft-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .status-text {
            flex: 1;
        }
        
        .status-text strong {
            color: #4682b4;
            font-size: 1.2rem;
            display: block;
            margin-bottom: 5px;
        }
        
        body.alarm-active .status-text strong {
            color: #ff6b6b;
        }
        
        .status-text span {
            color: #7f8c8d;
            font-size: 0.95rem;
        }
        
        /* Emergency Stop */
        .emergency-stop {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            transition: all 0.3s;
        }
        
        .emergency-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        .emergency-stop.visible {
            display: block;
            animation: gentle-bounce 2s infinite;
        }
        
        @keyframes gentle-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Sections */
        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(70, 130, 180, 0.08);
            border: 2px solid #e3f2fd;
        }
        
        h2 {
            color: #4682b4;
            margin-bottom: 25px;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e3f2fd;
        }
        
        h2 i {
            color: #63b3ed;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 1rem;
        }
        
        .label-hint {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 5px;
            font-weight: normal;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #e3f2fd;
            background: #f8fdff;
            color: #2c3e50;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #63b3ed;
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 179, 237, 0.1);
        }
        
        input::placeholder, textarea::placeholder {
            color: #a0b9c8;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Early Warning Option */
        .early-warning {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .early-warning input[type="number"] {
            width: 80px;
            padding: 10px;
            border-radius: 8px;
        }
        
        /* Personalized Voice Section */
        .voice-personalization {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 16px;
            margin: 20px 0;
            border: 2px solid #e1ecf4;
        }
        
        .name-input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .name-input-group input {
            flex: 1;
        }
        
        .voice-preview {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px dashed #e3f2fd;
        }
        
        .preview-message {
            color: #4682b4;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .message-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .message-option {
            background: #f8fdff;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e3f2fd;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .message-option:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
        }
        
        .message-option.selected {
            background: #63b3ed;
            border-color: #4682b4;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 179, 237, 0.2);
        }
        
        .message-option .icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }
        
        /* Buttons */
        button {
            padding: 18px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            letter-spacing: 0.3px;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4682b4, #63b3ed);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 179, 237, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 179, 237, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #e74c3c);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2);
        }
        
        .btn-secondary {
            background: #f8fdff;
            color: #4682b4;
            border: 2px solid #e3f2fd;
        }
        
        .btn-secondary:hover {
            background: #e3f2fd;
        }
        
        .btn-sm {
            padding: 12px 20px;
            font-size: 1rem;
            width: auto;
        }
        
        /* Goals List */
        .goals-list {
            margin-top: 20px;
        }
        
        .goal-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 6px solid #63b3ed;
            box-shadow: 0 4px 12px rgba(70, 130, 180, 0.08);
            transition: all 0.3s;
            animation: slide-up 0.5s ease;
        }
        
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .goal-card.ringing {
            border-left-color: #ff6b6b;
            background: #fff0f0;
            animation: gentle-alert 0.5s infinite;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.15);
        }
        
        @keyframes gentle-alert {
            0%, 100% { box-shadow: 0 4px 20px rgba(255, 107, 107, 0.15); }
            50% { box-shadow: 0 6px 25px rgba(255, 107, 107, 0.25); }
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .goal-title {
            font-weight: 600;
            font-size: 1.3rem;
            color: #2c3e50;
        }
        
        .goal-card.ringing .goal-title {
            color: #ff6b6b;
        }
        
        .goal-time {
            background: #f0f8ff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #4682b4;
            white-space: nowrap;
        }
        
        .goal-date {
            color: #63b3ed;
            font-size: 0.95rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .goal-description {
            color: #7f8c8d;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .goal-status {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 15px;
            background: #f0f8ff;
            color: #4682b4;
        }
        
        .goal-status.ringing {
            background: #ffebee;
            color: #ff6b6b;
        }
        
        .goal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .goal-actions button {
            padding: 14px;
            font-size: 1rem;
            margin: 0;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0b9c8;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 16px;
            animation: slide-up 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(70, 130, 180, 0.2);
            border: 2px solid #63b3ed;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #4682b4;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .notification-message {
            color: #2c3e50;
            line-height: 1.5;
        }
        
        .close-notification {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #a0b9c8;
            font-size: 1.5rem;
            cursor: pointer;
            width: auto;
            padding: 5px;
            line-height: 1;
        }
        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(70, 130, 180, 0.08);
            border: 2px solid #e3f2fd;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4682b4;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 2px solid #e3f2fd;
            color: #a0b9c8;
            font-size: 0.9rem;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .section {
                padding: 25px 20px;
            }
            
            .row {
                grid-template-columns: 1fr;
            }
            
            .message-options {
                grid-template-columns: 1fr;
            }
            
            .goal-actions {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .emergency-stop {
                top: 10px;
                right: 10px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Emergency Stop Button -->
        <button id="emergencyStopBtn" class="emergency-stop" onclick="stopAllAlarms()">
            ‚èπÔ∏è STOP ALARM
        </button>
        
        <!-- Header -->
        <header>
            <h1>
                <span style="color: #63b3ed;">‚è∞</span> Personal Focus Alarm
            </h1>
            <p class="subtitle">
                Beeps EXACTLY on time with continuous alerts until you start
            </p>
            
            <div class="alarm-status">
                <div id="alarmIndicator" class="alarm-indicator"></div>
                <div class="status-text">
                    <strong id="statusText">System Ready</strong>
                    <span id="alarmCount">Next check in 30s</span>
                </div>
            </div>
        </header>
        
        <!-- Statistics -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="totalGoals">0</div>
                <div class="stat-label">Total Goals</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="todayGoals">0</div>
                <div class="stat-label">Today</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="ringingAlarms">0</div>
                <div class="stat-label">Active Alarms</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completionRate">0%</div>
                <div class="stat-label">Completion</div>
            </div>
        </div>
        
        <!-- Schedule New Goal -->
        <div class="section">
            <h2><i>üìÖ</i> Schedule New Goal</h2>
            <form id="goalForm">
                <div class="form-group">
                    <label for="goalTitle">What's your task?</label>
                    <input type="text" id="goalTitle" placeholder="e.g., Complete Math assignment" required>
                    <span class="label-hint">Be specific about what you want to accomplish</span>
                </div>
                
                <div class="form-group">
                    <label for="goalDescription">Notes (Optional)</label>
                    <textarea id="goalDescription" placeholder="Additional details, resources, or instructions..." rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Schedule Date & Time</label>
                    <div class="row">
                        <div>
                            <label for="goalDate" style="font-size: 0.9rem;">Date</label>
                            <input type="date" id="goalDate" required>
                        </div>
                        <div>
                            <label for="startTime" style="font-size: 0.9rem;">Start Time</label>
                            <input type="time" id="startTime" required>
                        </div>
                    </div>
                    
                    <!-- Early Warning Option -->
                    <div class="early-warning">
                        <input type="checkbox" id="earlyWarning" checked>
                        <label for="earlyWarning" style="margin-bottom: 0; font-size: 0.9rem;">
                            Early warning (beep
                            <input type="number" id="warningMinutes" min="0" max="60" value="2" style="width: 50px;">
                            minutes before)
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="alarmDuration">Alarm Duration</label>
                    <select id="alarmDuration">
                        <option value="until_start">Until I start the task</option>
                        <option value="5min">5 minutes</option>
                        <option value="10min">10 minutes</option>
                        <option value="15min">15 minutes</option>
                        <option value="continuous">Continuous until stopped</option>
                    </select>
                </div>
                
                <!-- Personalized Voice Alarm -->
                <div class="voice-personalization">
                    <h3 style="color: #4682b4; margin-bottom: 20px; font-size: 1.2rem;">
                        <i>üé§</i> Personalized Voice Alarm
                    </h3>
                    
                    <div class="form-group">
                        <label for="userName">Your Name</label>
                        <div class="name-input-group">
                            <input type="text" id="userName" placeholder="Enter your name (e.g., Alex)" value="Alex">
                            <button type="button" class="btn-secondary btn-sm" onclick="previewVoiceMessage()">
                                üîä Preview
                            </button>
                        </div>
                        <span class="label-hint">The alarm will call you by this name</span>
                    </div>
                    
                    <div class="message-options">
                        <div class="message-option selected" onclick="selectMessage('wakeup')">
                            <span class="icon">‚è∞</span>
                            "Wake up, [Name]! It's time for work."
                        </div>
                        <div class="message-option" onclick="selectMessage('letsgo')">
                            <span class="icon">üöÄ</span>
                            "Come on, [Name]! Let's get started."
                        </div>
                        <div class="message-option" onclick="selectMessage('focused')">
                            <span class="icon">üéØ</span>
                            "Focus time, [Name]! Your goals are waiting."
                        </div>
                        <div class="message-option" onclick="selectMessage('motivational')">
                            <span class="icon">üí™</span>
                            "You can do this, [Name]! Time to shine."
                        </div>
                    </div>
                    
                    <div class="voice-preview">
                        <div class="preview-message" id="voicePreview">
                            "Wake up, Alex! It's time for work."
                        </div>
                        <button type="button" class="btn-secondary" onclick="testVoiceAlarm()">
                            üéµ Test Voice Alarm
                        </button>
                    </div>
                </div>
                
                <!-- Alternative Alarm Sounds -->
                <div class="form-group">
                    <label for="soundType">Alarm Sound</label>
                    <select id="soundType">
                        <option value="voice">Personalized Voice Message</option>
                        <option value="beep">Continuous Beep</option>
                        <option value="gentle">Gentle Bell</option>
                        <option value="digital">Digital Beep</option>
                        <option value="nature">Nature Sounds</option>
                    </select>
                    <span class="label-hint">For "Continuous until stopped" mode, alarm will repeat every 2 seconds</span>
                </div>
                
                <button type="submit" class="btn-primary">
                    <i>‚è∞</i> Set Personal Alarm
                </button>
            </form>
        </div>
        
        <!-- Your Scheduled Goals -->
        <div class="section">
            <h2><i>üìã</i> Your Scheduled Goals</h2>
            <div id="goalsList" class="goals-list">
                <div class="empty-state">
                    <div class="icon">üìù</div>
                    <p>No goals scheduled yet.</p>
                    <p style="margin-top: 10px; font-size: 0.95rem; color: #7f8c8d;">
                        Schedule your first goal above to get started!
                    </p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-danger" onclick="clearAllGoals()" style="width: auto; padding: 15px 30px;">
                    üóëÔ∏è Clear All Goals
                </button>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="section" style="background: #f0f8ff; border-color: #e1ecf4;">
            <h2><i>üìñ</i> How It Works</h2>
            <div style="display: grid; gap: 20px; margin-top: 20px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="background: #4682b4; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                    <div>
                        <strong style="color: #4682b4;">Set your name</strong>
                        <p style="color: #7f8c8d; margin-top: 5px;">Enter your name so the alarm can call you personally.</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="background: #4682b4; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</div>
                    <div>
                        <strong style="color: #4682b4;">Schedule your task</strong>
                        <p style="color: #7f8c8d; margin-top: 5px;">Choose date and time for when you want to work.</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="background: #4682b4; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                    <div>
                        <strong style="color: #4682b4;">Get precise reminders</strong>
                        <p style="color: #7f8c8d; margin-top: 5px;">Alarm beeps EXACTLY at set time (or 2 min before) and continues every 2 seconds.</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div style="background: #4682b4; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">4</div>
                    <div>
                        <strong style="color: #4682b4;">Start when ready</strong>
                        <p style="color: #7f8c8d; margin-top: 5px;">Click "Start Now" to begin working. Alarm stops immediately.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Personal Focus Alarm ¬© 2024 | Beeps precisely on time</p>
            <p style="margin-top: 10px; font-size: 0.85rem;">
                <span id="pwaStatus">Works best when app is open in browser tab</span>
            </p>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification" style="display: none;">
        <button class="close-notification" onclick="closeNotification()">√ó</button>
        <div class="notification-title">
            <span id="notificationIcon">üîî</span>
            <span id="notificationTitleText">Notification</span>
        </div>
        <div class="notification-message" id="notificationMessage"></div>
    </div>

    <script>
        // ====================
        // APP STATE
        // ====================
        let goals = JSON.parse(localStorage.getItem('personalAlarms')) || [];
        let activeAlarms = new Map();
        let selectedMessageType = 'wakeup';
        let userName = 'Alex';
        let isVoicePlaying = false;
        let alarmAudioContext = null;
        
        // Voice messages templates
        const voiceMessages = {
            wakeup: {
                text: "Wake up, {name}! It's time for work. Let's get started!",
                tone: 'urgent'
            },
            letsgo: {
                text: "Come on, {name}! Let's go! Your work is waiting for you. Time to focus!",
                tone: 'energetic'
            },
            focused: {
                text: "Focus time, {name}! Your goals are waiting. Let's make progress together!",
                tone: 'calm'
            },
            motivational: {
                text: "You can do this, {name}! Time to shine. I know you've got this! Let's begin!",
                tone: 'encouraging'
            }
        };
        
        // ====================
        // INITIALIZATION
        // ====================
        function initApp() {
            console.log("Initializing Personal Focus Alarm...");
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('goalDate').value = today;
            document.getElementById('goalDate').min = today;
            
            // Set default time to next 30 minutes
            const next30min = new Date();
            next30min.setMinutes(next30min.getMinutes() + 30);
            document.getElementById('startTime').value = 
                `${next30min.getHours().toString().padStart(2, '0')}:${next30min.getMinutes().toString().padStart(2, '0')}`;
            
            // Load user name from localStorage
            const savedName = localStorage.getItem('userName');
            if (savedName) {
                userName = savedName;
                document.getElementById('userName').value = userName;
                updateVoicePreview();
            }
            
            // Setup form submission
            document.getElementById('goalForm').addEventListener('submit', addGoal);
            
            // Update voice preview when name changes
            document.getElementById('userName').addEventListener('input', function() {
                userName = this.value.trim() || 'Alex';
                localStorage.setItem('userName', userName);
                updateVoicePreview();
            });
            
            // Load saved goals
            loadGoals();
            
            // Setup alarm checking with high precision
            startPreciseAlarmChecker();
            
            // Initial render
            renderGoals();
            updateStats();
            
            // Show welcome message
            setTimeout(() => {
                showNotification("Welcome!", 
                    "Hello " + userName + "! üëã Alarms now beep EXACTLY on time and continuously every 2 seconds.");
            }, 1000);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission();
                }, 2000);
            }
            
            // Initialize audio context
            initAudioContext();
            
            // Listen for app visibility changes
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // App became visible - check for missed alarms
                    checkMissedAlarms();
                }
            });
        }
        
        function initAudioContext() {
            try {
                alarmAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log("Audio context initialized for precise timing");
            } catch (e) {
                console.log("Web Audio API not supported:", e);
            }
        }
        
        // ====================
        // PRECISE ALARM SYSTEM
        // ====================
        
        function startPreciseAlarmChecker() {
            // High-precision checking every second
            setInterval(checkAllAlarms, 1000);
            
            // Update UI every 30 seconds
            setInterval(updateTimeDisplay, 30000);
            
            console.log("Precise alarm system started (1-second precision)");
        }
        
        function updateTimeDisplay() {
            const now = new Date();
            const nextMinute = 60 - now.getSeconds();
            document.getElementById('alarmCount').textContent = 
                `Next check: ${nextMinute}s | ${getNextAlarmTime()}`;
        }
        
        function getNextAlarmTime() {
            const pendingGoals = goals.filter(g => g.status === 'pending');
            if (pendingGoals.length === 0) return "No pending alarms";
            
            const now = new Date();
            let nearestTime = Infinity;
            let nearestGoal = null;
            
            pendingGoals.forEach(goal => {
                const goalDateTime = new Date(goal.date + 'T' + goal.startTime);
                if (goal.earlyWarning) {
                    goalDateTime.setMinutes(goalDateTime.getMinutes() - goal.warningMinutes);
                }
                
                if (goalDateTime > now && goalDateTime.getTime() < nearestTime) {
                    nearestTime = goalDateTime.getTime();
                    nearestGoal = goal;
                }
            });
            
            if (nearestGoal) {
                const goalDateTime = new Date(nearestGoal.date + 'T' + nearestGoal.startTime);
                const timeDiff = goalDateTime - now;
                const minutes = Math.floor(timeDiff / 60000);
                const seconds = Math.floor((timeDiff % 60000) / 1000);
                
                if (minutes > 0) {
                    return `Next alarm in ${minutes}m ${seconds}s`;
                } else {
                    return `Next alarm in ${seconds}s`;
                }
            }
            
            return "Checking...";
        }
        
        function checkAllAlarms() {
            const now = new Date();
            let ringingCount = 0;
            
            goals.forEach(goal => {
                // Check if alarm should start
                if (goal.status === 'pending' || goal.status === 'overdue') {
                    const goalDateTime = new Date(goal.date + 'T' + goal.startTime);
                    const warningTime = new Date(goalDateTime);
                    
                    // Check for early warning
                    if (goal.earlyWarning && goal.warningMinutes > 0) {
                        warningTime.setMinutes(warningTime.getMinutes() - goal.warningMinutes);
                    }
                    
                    // Check if it's time for early warning
                    if (goal.earlyWarning && goal.warningMinutes > 0 && now >= warningTime && now < goalDateTime) {
                        if (!goal.earlyWarningTriggered) {
                            triggerEarlyWarning(goal);
                            goal.earlyWarningTriggered = true;
                            saveGoals();
                        }
                    }
                    
                    // Check if it's exactly the alarm time
                    if (now >= goalDateTime) {
                        // Time to start continuous alarm!
                        if (!activeAlarms.has(goal.id)) {
                            startContinuousAlarm(goal);
                        }
                        if (goal.status !== 'overdue') {
                            goal.status = 'overdue';
                            saveGoals();
                        }
                    }
                }
                
                // Count ringing alarms
                if (activeAlarms.has(goal.id)) {
                    ringingCount++;
                }
            });
            
            updateAlarmStatus(ringingCount);
            if (ringingCount > 0) {
                renderGoals();
            }
        }
        
        function checkMissedAlarms() {
            const now = new Date();
            const missedAlarms = goals.filter(goal => {
                if (goal.status === 'pending') {
                    const goalDateTime = new Date(goal.date + 'T' + goal.startTime);
                    return now >= goalDateTime && !activeAlarms.has(goal.id);
                }
                return false;
            });
            
            if (missedAlarms.length > 0) {
                missedAlarms.forEach(goal => {
                    showNotification("Missed Alarm!", 
                        `"${goal.title}" was scheduled for ${goal.startTime}\n` +
                        `Starting alarm now!`);
                    startContinuousAlarm(goal);
                });
            }
        }
        
        function triggerEarlyWarning(goal) {
            console.log(`üîî Early warning for: ${goal.title}`);
            
            // Play single beep for early warning
            playBeepSound('warning');
            
            // Show notification
            const warningMins = goal.warningMinutes || 2;
            showNotification("‚è∞ Coming Soon!", 
                `"${goal.title}" starts in ${warningMins} minute${warningMins === 1 ? '' : 's'}!\n` +
                `Get ready to start working, ${userName}!`,
                false);
        }
        
        function startContinuousAlarm(goal) {
            console.log(`üîä Starting CONTINUOUS alarm for: ${goal.title}`);
            
            // Clear any existing alarm for this goal
            if (activeAlarms.has(goal.id)) {
                clearInterval(activeAlarms.get(goal.id).interval);
                activeAlarms.delete(goal.id);
            }
            
            // Mark as ringing
            goal.isRinging = true;
            goal.alarmStartedAt = new Date().toISOString();
            saveGoals();
            
            // Play first alarm immediately
            playAlarmSound(goal);
            
            // Start continuous alarm interval (every 2 seconds for true continuity)
            const alarmInterval = setInterval(() => {
                playAlarmSound(goal);
            }, 2000); // Repeat every 2 seconds
            
            // Store interval
            activeAlarms.set(goal.id, {
                interval: alarmInterval,
                audio: null,
                duration: goal.duration || 'until_start',
                startTime: Date.now()
            });
            
            // Update UI
            document.body.classList.add('alarm-active');
            document.getElementById('emergencyStopBtn').classList.add('visible');
            
            // Show urgent notification
            const overdueTime = Math.floor((Date.now() - new Date(goal.date + 'T' + goal.startTime).getTime()) / 1000);
            showNotification("üîä ALARM ACTIVE!", 
                `"${goal.title}" is NOW!\n\n` +
                `Hey ${userName}! It's time to work!\n` +
                `Alarm will beep continuously every 2 seconds until you start.`,
                true);
            
            // Set timeout to stop alarm if duration is specified (not 'until_start' or 'continuous')
            if (goal.duration && goal.duration !== 'until_start' && goal.duration !== 'continuous') {
                let durationMs = 0;
                switch(goal.duration) {
                    case '5min': durationMs = 5 * 60 * 1000; break;
                    case '10min': durationMs = 10 * 60 * 1000; break;
                    case '15min': durationMs = 15 * 60 * 1000; break;
                }
                
                setTimeout(() => {
                    if (activeAlarms.has(goal.id)) {
                        stopAlarmForGoal(goal.id);
                        showNotification("Alarm Completed", 
                            `${userName}, the alarm has stopped after ${goal.duration}.`);
                    }
                }, durationMs);
            }
        }
        
        function playAlarmSound(goal) {
            const soundType = goal.soundType || 'voice';
            
            switch(soundType) {
                case 'voice':
                    playPersonalVoiceAlarm(goal);
                    break;
                case 'beep':
                    playContinuousBeep();
                    break;
                case 'gentle':
                    playGentleBell();
                    break;
                case 'digital':
                    playDigitalBeep();
                    break;
                case 'nature':
                    playNatureSound();
                    break;
            }
            
            // Vibrate if on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(200); // Vibrate for 200ms
            }
        }
        
        function playContinuousBeep() {
            if (!alarmAudioContext) return;
            
            try {
                const oscillator = alarmAudioContext.createOscillator();
                const gainNode = alarmAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(alarmAudioContext.destination);
                
                // Short, sharp beep
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                // Quick attack, quick release
                const now = alarmAudioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                
                oscillator.start(now);
                oscillator.stop(now + 0.15);
                
            } catch (e) {
                console.log('Beep error:', e);
            }
        }
        
        function playBeepSound(type = 'warning') {
            if (!alarmAudioContext) return;
            
            try {
                const oscillator = alarmAudioContext.createOscillator();
                const gainNode = alarmAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(alarmAudioContext.destination);
                
                if (type === 'warning') {
                    // Gentle warning beep
                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';
                    
                    const now = alarmAudioContext.currentTime;
                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(0.2, now + 0.1);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                    
                    oscillator.start(now);
                    oscillator.stop(now + 0.5);
                } else {
                    // Standard beep
                    playContinuousBeep();
                }
                
            } catch (e) {
                console.log('Beep error:', e);
            }
        }
        
        function playGentleBell() {
            if (!alarmAudioContext) return;
            
            try {
                const oscillator = alarmAudioContext.createOscillator();
                const gainNode = alarmAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(alarmAudioContext.destination);
                
                oscillator.frequency.value = 523.25; // C5
                oscillator.type = 'sine';
                
                const now = alarmAudioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.2, now + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                
                oscillator.start(now);
                oscillator.stop(now + 1.5);
                
            } catch (e) {
                console.log('Bell error:', e);
            }
        }
        
        function playDigitalBeep() {
            if (!alarmAudioContext) return;
            
            try {
                const oscillator = alarmAudioContext.createOscillator();
                const gainNode = alarmAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(alarmAudioContext.destination);
                
                oscillator.frequency.value = 1000;
                oscillator.type = 'square';
                
                const now = alarmAudioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.05);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.15);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.2);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
                
            } catch (e) {
                console.log('Digital beep error:', e);
            }
        }
        
        function playNatureSound() {
            if (!alarmAudioContext) return;
            
            try {
                const oscillator = alarmAudioContext.createOscillator();
                const gainNode = alarmAudioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(alarmAudioContext.destination);
                
                // Bird chirp
                oscillator.frequency.setValueAtTime(2000, alarmAudioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1500, alarmAudioContext.currentTime + 0.3);
                oscillator.type = 'sine';
                
                const now = alarmAudioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.2, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
                
            } catch (e) {
                console.log('Nature sound error:', e);
            }
        }
        
        function playPersonalVoiceAlarm(goal) {
            if (isVoicePlaying) return;
            
            isVoicePlaying = true;
            
            // Get the selected message template
            const messageTemplate = voiceMessages[goal.messageType || selectedMessageType];
            
            // Replace {name} with actual user name
            const messageText = messageTemplate.text.replace('{name}', userName);
            
            // Create speech synthesis
            if ('speechSynthesis' in window) {
                // Stop any ongoing speech
                window.speechSynthesis.cancel();
                
                // Create new utterance
                const utterance = new SpeechSynthesisUtterance(messageText);
                
                // Configure voice
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Try to find a good voice
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Google') || 
                    voice.name.includes('Samantha') || 
                    voice.name.includes('Daniel')
                );
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                // Play the message
                window.speechSynthesis.speak(utterance);
                
                // When speech ends
                utterance.onend = function() {
                    isVoicePlaying = false;
                };
                
                utterance.onerror = function() {
                    isVoicePlaying = false;
                    // Fallback to beep if voice fails
                    playContinuousBeep();
                };
                
            } else {
                // Fallback to beep
                playContinuousBeep();
                isVoicePlaying = false;
            }
        }
        
        function stopAlarmForGoal(goalId) {
            if (activeAlarms.has(goalId)) {
                const alarmData = activeAlarms.get(goalId);
                clearInterval(alarmData.interval);
                activeAlarms.delete(goalId);
                
                // Stop any speech
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
                
                // Stop any audio
                if (alarmAudioContext && alarmAudioContext.state !== 'closed') {
                    alarmAudioContext.close();
                    alarmAudioContext = null;
                    initAudioContext(); // Reinitialize for next alarm
                }
                
                const goal = goals.find(g => g.id === goalId);
                if (goal) {
                    goal.isRinging = false;
                    goal.earlyWarningTriggered = false;
                    saveGoals();
                }
                
                console.log(`üîá Stopped alarm for goal: ${goalId}`);
            }
            
            // Check if all alarms are stopped
            const ringingCount = Array.from(activeAlarms.keys()).length;
            if (ringingCount === 0) {
                document.body.classList.remove('alarm-active');
                document.getElementById('emergencyStopBtn').classList.remove('visible');
            }
            
            updateAlarmStatus(ringingCount);
            renderGoals();
        }
        
        function stopAllAlarms() {
            console.log("Stopping all alarms...");
            
            // Clear all intervals
            activeAlarms.forEach((alarmData, goalId) => {
                clearInterval(alarmData.interval);
                
                // Update goal
                const goal = goals.find(g => g.id === goalId);
                if (goal) {
                    goal.isRinging = false;
                    goal.earlyWarningTriggered = false;
                }
            });
            
            // Clear map
            activeAlarms.clear();
            
            // Stop speech synthesis
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            
            // Stop audio context
            if (alarmAudioContext && alarmAudioContext.state !== 'closed') {
                alarmAudioContext.close();
                alarmAudioContext = null;
            }
            
            // Reset UI
            document.body.classList.remove('alarm-active');
            document.getElementById('emergencyStopBtn').classList.remove('visible');
            
            // Update
            updateAlarmStatus(0);
            renderGoals();
            saveGoals();
            
            showNotification("Alarms Stopped", 
                `${userName}, all alarms have been stopped. You can set new alarms when ready.`);
        }
        
        // ====================
        // VOICE MESSAGE CONTROLS
        // ====================
        
        function selectMessage(type) {
            selectedMessageType = type;
            
            // Update UI
            document.querySelectorAll('.message-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.message-option')[getMessageIndex(type)].classList.add('selected');
            
            // Update preview
            updateVoicePreview();
        }
        
        function getMessageIndex(type) {
            const types = ['wakeup', 'letsgo', 'focused', 'motivational'];
            return types.indexOf(type);
        }
        
        function updateVoicePreview() {
            const message = voiceMessages[selectedMessageType];
            const previewText = message.text.replace('{name}', userName);
            document.getElementById('voicePreview').textContent = `"${previewText}"`;
        }
        
        function previewVoiceMessage() {
            const nameInput = document.getElementById('userName');
            userName = nameInput.value.trim() || 'Alex';
            localStorage.setItem('userName', userName);
            
            updateVoicePreview();
            testVoiceAlarm();
        }
        
        function testVoiceAlarm() {
            // Create a test goal object
            const testGoal = {
                messageType: selectedMessageType,
                soundType: 'voice'
            };
            
            playPersonalVoiceAlarm(testGoal);
            
            showNotification("Voice Test", 
                `Playing personalized message for ${userName}`);
        }
        
        // ====================
        // GOAL MANAGEMENT
        // ====================
        
        function addGoal(event) {
            event.preventDefault();
            
            const title = document.getElementById('goalTitle').value.trim();
            const description = document.getElementById('goalDescription').value.trim();
            const date = document.getElementById('goalDate').value;
            const startTime = document.getElementById('startTime').value;
            const duration = document.getElementById('alarmDuration').value;
            const soundType = document.getElementById('soundType').value;
            const earlyWarning = document.getElementById('earlyWarning').checked;
            const warningMinutes = parseInt(document.getElementById('warningMinutes').value) || 2;
            
            // Validation
            if (!title || !date || !startTime) {
                showNotification("Missing Information", "Please fill in all required fields");
                return;
            }
            
            const goalDateTime = new Date(date + 'T' + startTime);
            if (goalDateTime < new Date()) {
                showNotification("Invalid Time", "Please select a future date and time");
                return;
            }
            
            // Create goal
            const goal = {
                id: Date.now() + Math.random(), // More unique ID
                title,
                description,
                date,
                startTime,
                duration,
                soundType,
                messageType: selectedMessageType,
                userName: userName,
                earlyWarning: earlyWarning,
                warningMinutes: warningMinutes,
                status: 'pending',
                createdAt: new Date().toISOString(),
                isRinging: false,
                earlyWarningTriggered: false
            };
            
            goals.push(goal);
            saveGoals();
            renderGoals();
            
            // Reset form (keep name and date)
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDescription').value = '';
            const nextTime = new Date();
            nextTime.setMinutes(nextTime.getMinutes() + 30);
            document.getElementById('startTime').value = 
                `${nextTime.getHours().toString().padStart(2, '0')}:${nextTime.getMinutes().toString().padStart(2, '0')}`;
            
            // Show success
            const formattedDate = new Date(date).toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            
            let timeInfo = formatTime(startTime);
            if (earlyWarning) {
                timeInfo += ` (with ${warningMinutes}-minute early warning)`;
            }
            
            showNotification("‚úÖ Alarm Set Successfully!", 
                `"${title}"\nüìÖ ${formattedDate} at ${timeInfo}\n` +
                `üîä Alarm: ${soundType === 'voice' ? 'Personalized voice' : soundType}\n` +
                `‚è∞ Will beep continuously every 2 seconds until you start!\n\n` +
                `Get ready to work, ${userName}!`);
        }
        
        function startGoal(goalId) {
            // Stop the alarm first
            stopAlarmForGoal(goalId);
            
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            goal.status = 'active';
            goal.startedAt = new Date().toISOString();
            goal.isRinging = false;
            
            saveGoals();
            renderGoals();
            
            // Show personalized confirmation
            showNotification("üéØ Let's Get Started!", 
                `Perfect timing, ${userName}! You're now working on "${goal.title}"\n` +
                `The alarm has stopped. Stay focused and do your best!`);
        }
        
        function completeGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            // Stop alarm if ringing
            stopAlarmForGoal(goalId);
            
            goal.status = 'completed';
            goal.completedAt = new Date().toISOString();
            goal.isRinging = false;
            
            saveGoals();
            renderGoals();
            
            // Calculate duration
            const duration = goal.startedAt ? 
                Math.round((new Date(goal.completedAt) - new Date(goal.startedAt)) / 60000) : 0;
            
            // Show personalized congratulations
            showNotification("üéâ Excellent Work!", 
                `Well done, ${userName}! You completed "${goal.title}"\n` +
                `‚è±Ô∏è Focus time: ${duration} minute${duration === 1 ? '' : 's'}\n` +
                `Keep up the great work!`);
        }
        
        function removeGoal(goalId) {
            if (!confirm("Remove this goal and stop its alarm?")) return;
            
            stopAlarmForGoal(goalId);
            
            goals = goals.filter(g => g.id !== goalId);
            saveGoals();
            renderGoals();
            
            showNotification("Goal Removed", 
                "Goal and alarm have been removed from your list");
        }
        
        // ====================
        // UI UPDATES
        // ====================
        
        function updateAlarmStatus(ringingCount) {
            const indicator = document.getElementById('alarmIndicator');
            const statusText = document.getElementById('statusText');
            const alarmCount = document.getElementById('alarmCount');
            
            if (ringingCount > 0) {
                indicator.classList.add('ringing');
                statusText.textContent = `${ringingCount} Alarm${ringingCount === 1 ? '' : 's'} Active`;
                statusText.style.color = '#ff6b6b';
                alarmCount.textContent = `Continuous beeping every 2 seconds!`;
                alarmCount.style.color = '#ff6b6b';
                document.getElementById('ringingAlarms').textContent = ringingCount;
            } else {
                indicator.classList.remove('ringing');
                statusText.textContent = 'System Ready';
                statusText.style.color = '#4682b4';
                alarmCount.textContent = getNextAlarmTime();
                alarmCount.style.color = '#7f8c8d';
                document.getElementById('ringingAlarms').textContent = '0';
            }
        }
        
        function renderGoals() {
            const container = document.getElementById('goalsList');
            
            if (goals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <p>No goals scheduled yet.</p>
                        <p style="margin-top: 10px; font-size: 0.95rem; color: #7f8c8d;">
                            Schedule your first goal above to get started!
                        </p>
                    </div>
                `;
                return;
            }
            
            // Sort: ringing first, then today's goals, then future
            const sortedGoals = [...goals].sort((a, b) => {
                if (a.isRinging && !b.isRinging) return -1;
                if (!a.isRinging && b.isRinging) return 1;
                
                const aDate = new Date(a.date + 'T' + a.startTime);
                const bDate = new Date(b.date + 'T' + b.startTime);
                return aDate - bDate;
            });
            
            container.innerHTML = sortedGoals.map(goal => {
                const start = formatTime(goal.startTime);
                const date = new Date(goal.date).toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                const isToday = goal.date === new Date().toISOString().split('T')[0];
                
                // Time until start
                const now = new Date();
                const goalDateTime = new Date(goal.date + 'T' + goal.startTime);
                let timeInfo = '';
                
                if (goal.status === 'pending') {
                    const timeDiff = goalDateTime - now;
                    if (timeDiff > 0) {
                        const minutes = Math.floor(timeDiff / 60000);
                        const seconds = Math.floor((timeDiff % 60000) / 1000);
                        
                        if (minutes > 0) {
                            timeInfo = `‚è≥ Starts in ${minutes}m ${seconds}s`;
                        } else {
                            timeInfo = `‚è≥ Starts in ${seconds}s`;
                        }
                        
                        if (goal.earlyWarning && goal.warningMinutes > 0 && minutes <= goal.warningMinutes) {
                            timeInfo += ` (‚ö†Ô∏è ${goal.warningMinutes}-min warning active)`;
                        }
                    }
                }
                
                // Get sound icon
                let soundIcon = 'üîä';
                if (goal.soundType === 'voice') soundIcon = 'üé§';
                else if (goal.soundType === 'beep') soundIcon = 'üîî';
                else if (goal.soundType === 'gentle') soundIcon = 'üîî';
                else if (goal.soundType === 'digital') soundIcon = 'üìü';
                else if (goal.soundType === 'nature') soundIcon = 'üåø';
                
                return `
                    <div class="goal-card ${goal.isRinging ? 'ringing' : ''}" data-id="${goal.id}">
                        <div class="goal-header">
                            <div>
                                <div class="goal-title">${goal.title}</div>
                                <div class="goal-date">
                                    üìÖ ${date} ${isToday ? '‚Ä¢ Today' : ''} ‚Ä¢ ${start}
                                    ${goal.earlyWarning ? `‚Ä¢ ‚è∞ ${goal.warningMinutes || 2}-min warning` : ''}
                                </div>
                            </div>
                            <div class="goal-time">
                                ${soundIcon} ${goal.duration === 'continuous' ? 'Continuous' : goal.duration}
                            </div>
                        </div>
                        
                        ${goal.description ? `
                            <div class="goal-description">${goal.description}</div>
                        ` : ''}
                        
                        <div class="goal-status ${goal.isRinging ? 'ringing' : ''}">
                            ${goal.status.toUpperCase()} 
                            ${goal.isRinging ? '‚Ä¢ üîä BEEPING CONTINUOUSLY!' : ''}
                            ${goal.earlyWarningTriggered && !goal.isRinging ? '‚Ä¢ ‚ö†Ô∏è Early warning sent' : ''}
                        </div>
                        
                        ${timeInfo ? `
                            <div style="color: #63b3ed; margin: 10px 0; font-size: 0.95rem; font-weight: 500;">
                                ${timeInfo}
                            </div>
                        ` : ''}
                        
                        ${goal.isRinging ? `
                            <div style="background: #ffebee; padding: 15px; border-radius: 12px; margin: 15px 0; color: #ff6b6b; border: 2px solid #ffcdd2;">
                                <strong>üîä CONTINUOUS ALARM ACTIVE!</strong>
                                <p style="margin-top: 8px; font-size: 0.95rem;">
                                    Beeping every 2 seconds to get ${goal.userName}'s attention!
                                    Started ${formatDuration(Date.now() - new Date(goal.alarmStartedAt).getTime())} ago.
                                </p>
                            </div>
                        ` : ''}
                        
                        <div class="goal-actions">
                            ${goal.status === 'pending' || goal.status === 'overdue' ? `
                                <button class="btn-success" onclick="startGoal(${goal.id})">
                                    ${goal.isRinging ? 'üõë STOP & START' : '‚ñ∂Ô∏è START NOW'}
                                </button>
                            ` : ''}
                            
                            ${goal.status === 'active' ? `
                                <button class="btn-primary" onclick="completeGoal(${goal.id})">
                                    ‚úÖ COMPLETE
                                </button>
                            ` : ''}
                            
                            <button class="btn-danger" onclick="removeGoal(${goal.id})">
                                üóëÔ∏è REMOVE
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            if (seconds < 60) return `${seconds} second${seconds === 1 ? '' : 's'}`;
            const minutes = Math.floor(seconds / 60);
            return `${minutes} minute${minutes === 1 ? '' : 's'}`;
        }
        
        function updateStats() {
            const total = goals.length;
            const today = new Date().toISOString().split('T')[0];
            const todayGoals = goals.filter(g => g.date === today).length;
            const ringing = Array.from(activeAlarms.keys()).length;
            const completed = goals.filter(g => g.status === 'completed').length;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('totalGoals').textContent = total;
            document.getElementById('todayGoals').textContent = todayGoals;
            document.getElementById('ringingAlarms').textContent = ringing;
            document.getElementById('completionRate').textContent = completionRate + '%';
        }
        
        // ====================
        // UTILITIES
        // ====================
        
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes.padStart(2, '0')} ${ampm}`;
        }
        
        function showNotification(title, message, urgent = false) {
            const notification = document.getElementById('notification');
            const titleEl = document.getElementById('notificationTitleText');
            const messageEl = document.getElementById('notificationMessage');
            const icon = document.getElementById('notificationIcon');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            if (urgent) {
                notification.style.borderColor = '#ff6b6b';
                icon.textContent = 'üîä';
            } else {
                notification.style.borderColor = '#63b3ed';
                icon.textContent = 'üîî';
            }
            
            notification.style.display = 'block';
            
            // Auto-close after 8 seconds if not urgent
            if (!urgent) {
                setTimeout(() => {
                    if (notification.style.display === 'block') {
                        closeNotification();
                    }
                }, 8000);
            }
        }
        
        function closeNotification() {
            document.getElementById('notification').style.display = 'none';
        }
        
        function saveGoals() {
            localStorage.setItem('personalAlarms', JSON.stringify(goals));
            updateStats();
        }
        
        function loadGoals() {
            const saved = JSON.parse(localStorage.getItem('personalAlarms'));
            if (saved) {
                goals = saved;
                
                // Check if any alarms should be ringing
                const now = new Date();
                goals.forEach(goal => {
                    if (goal.status === 'pending') {
                        const goalDateTime = new Date(goal.date + 'T' + goal.startTime);
                        if (now >= goalDateTime) {
                            goal.status = 'overdue';
                            goal.isRinging = false;
                        }
                    }
                });
                saveGoals();
            }
        }
        
        function clearAllGoals() {
            if (!confirm("Remove all goals and stop all alarms?")) return;
            
            stopAllAlarms();
            goals = [];
            saveGoals();
            renderGoals();
            
            showNotification("All Cleared", 
                "All goals and alarms have been removed");
        }
        
        // ====================
        // INITIALIZE
        // ====================
        
        window.addEventListener('DOMContentLoaded', initApp);
        
        // Export functions for buttons
        window.startGoal = startGoal;
        window.completeGoal = completeGoal;
        window.removeGoal = removeGoal;
        window.stopAllAlarms = stopAllAlarms;
        window.clearAllGoals = clearAllGoals;
        window.selectMessage = selectMessage;
        window.previewVoiceMessage = previewVoiceMessage;
        window.testVoiceAlarm = testVoiceAlarm;
        window.closeNotification = closeNotification;
    </script>
</body>
</html>

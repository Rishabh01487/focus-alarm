<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focus Alarm Pro</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Styles -->
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #4cc9f0;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --dark: #1a1a2e;
            --darker: #0d0d1a;
            --light: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark);
            color: var(--light);
            min-height: 100vh;
            padding: 15px;
            background: linear-gradient(135deg, var(--dark) 0%, #16213e 100%);
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 80px;
        }
        
        /* Header */
        .app-header {
            text-align: center;
            padding: 25px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .app-title {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .app-subtitle {
            color: #a9a9a9;
            font-size: 1rem;
            margin-bottom: 20px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #a9a9a9;
            margin-top: 5px;
        }
        
        /* Goal Form */
        .goal-form-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            font-family: inherit;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.3);
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Buttons */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d35400);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Goals List */
        .goals-list {
            margin-top: 25px;
        }
        
        .goal-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid var(--secondary);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }
        
        .goal-item.pending {
            border-left-color: var(--secondary);
        }
        
        .goal-item.active {
            border-left-color: var(--warning);
            animation: pulse 2s infinite;
            box-shadow: 0 0 0 1px rgba(243, 156, 18, 0.3);
        }
        
        .goal-item.completed {
            border-left-color: var(--success);
            opacity: 0.8;
        }
        
        .goal-item.overdue {
            border-left-color: var(--danger);
            animation: shake 0.5s ease-in-out;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .goal-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--secondary);
        }
        
        .goal-time {
            font-size: 0.9rem;
            color: #a9a9a9;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 20px;
            white-space: nowrap;
        }
        
        .goal-description {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .goal-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            border-radius: 3px;
            width: 0%;
            transition: width 1s ease;
        }
        
        .goal-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .goal-actions button {
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        /* Status Indicators */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .status-pending {
            background: rgba(76, 201, 240, 0.2);
            color: var(--secondary);
        }
        
        .status-active {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
        }
        
        .status-completed {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success);
        }
        
        .status-overdue {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
            opacity: 0.5;
        }
        
        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 100%;
            max-width: 350px;
            z-index: 1000;
        }
        
        .notification {
            background: rgba(231, 76, 60, 0.9);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            animation: slideInRight 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-message {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }
        
        /* Settings Panel */
        .settings-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(243, 156, 18, 0); }
            100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .app-header {
                padding: 20px 15px;
            }
            
            .goal-form-container {
                padding: 20px;
            }
            
            .time-inputs {
                grid-template-columns: 1fr;
            }
            
            .goal-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="app-header">
            <h1 class="app-title">
                <span>‚è∞</span> Focus Alarm Pro
            </h1>
            <p class="app-subtitle">Set goals, stay focused, and get reminders when you forget</p>
            
            <!-- Install Button -->
            <div id="installContainer" style="display: none; margin-top: 15px;">
                <button id="installButton" class="btn btn-secondary">
                    üì≤ Install App
                </button>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalGoals">0</div>
                <div class="stat-label">Total Goals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeGoals">0</div>
                <div class="stat-label">Active Now</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedToday">0</div>
                <div class="stat-label">Completed Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="overdueGoals">0</div>
                <div class="stat-label">Overdue</div>
            </div>
        </div>
        
        <!-- Goal Form -->
        <div class="goal-form-container">
            <h2 class="section-title">
                <span>üéØ</span> Add New Goal
            </h2>
            
            <form id="goalForm">
                <div class="form-group">
                    <label for="goalTitle">Goal Title *</label>
                    <input 
                        type="text" 
                        id="goalTitle" 
                        placeholder="What do you want to accomplish?"
                        maxlength="60"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="goalDescription">Description (Optional)</label>
                    <textarea 
                        id="goalDescription" 
                        placeholder="Add details, notes, or instructions..."
                        rows="3"
                    ></textarea>
                </div>
                
                <div class="form-group">
                    <label>Time Schedule *</label>
                    <div class="time-inputs">
                        <div>
                            <label for="startTime" style="font-size: 0.9rem;">Start Time</label>
                            <input type="time" id="startTime" required>
                        </div>
                        <div>
                            <label for="endTime" style="font-size: 0.9rem;">End Time</label>
                            <input type="time" id="endTime" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reminderSound">Reminder Sound</label>
                    <select id="reminderSound">
                        <option value="focus">Focus Alarm</option>
                        <option value="urgent">Urgent Beep</option>
                        <option value="bell">School Bell</option>
                        <option value="buzzer">Buzzer</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reminderFrequency">Reminder Frequency (if overdue)</label>
                    <select id="reminderFrequency">
                        <option value="5">Every 5 minutes</option>
                        <option value="10">Every 10 minutes</option>
                        <option value="15">Every 15 minutes</option>
                        <option value="30">Every 30 minutes</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span>‚ûï</span> Add Goal
                </button>
            </form>
        </div>
        
        <!-- Active Goals -->
        <div class="goal-form-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title">
                    <span>üìã</span> Today's Goals
                </h2>
                <button class="btn btn-secondary" onclick="clearCompletedGoals()" style="width: auto; padding: 10px 15px;">
                    üóëÔ∏è Clear Completed
                </button>
            </div>
            
            <div id="goalsList" class="goals-list">
                <!-- Goals will be inserted here -->
                <div class="empty-state">
                    <span>üìù</span>
                    <p>No goals added yet.</p>
                    <p style="margin-top: 10px; font-size: 0.9rem;">Add your first goal above!</p>
                </div>
            </div>
        </div>
        
        <!-- Settings -->
        <div class="settings-panel">
            <h2 class="section-title">
                <span>‚öôÔ∏è</span> Settings
            </h2>
            
            <div class="setting-item">
                <div class="setting-label">
                    <strong>üîî Enable Notifications</strong>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 3px;">
                        Get browser notifications
                    </div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="notificationsEnabled" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">
                    <strong>üîä Sound Alarms</strong>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 3px;">
                        Play sound when goals are overdue
                    </div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="soundEnabled" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">
                    <strong>üì≥ Vibration</strong>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 3px;">
                        Vibrate on reminders (Android PWA)
                    </div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="vibrationEnabled" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <div class="setting-label">
                    <strong>üîÑ Auto-start Next Goal</strong>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 3px;">
                        Automatically start next pending goal
                    </div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoStartEnabled">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div style="display: grid; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="requestNotificationPermission()">
                    üîî Enable Push Notifications
                </button>
                
                <button class="btn btn-warning" onclick="testAlarm()">
                    üîä Test Alarm Sound
                </button>
                
                <button class="btn btn-danger" onclick="clearAllGoals()">
                    üóëÔ∏è Clear All Goals
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Focus Alarm Pro &copy; 2024 | Stay focused, achieve more!</p>
            <p style="margin-top: 5px; font-size: 0.8rem;">
                <span id="vibrationStatusText" style="color: var(--secondary);">Checking vibration support...</span>
            </p>
        </div>
    </div>
    
    <!-- Notifications Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // ====================
        // APP STATE
        // ====================
        let goals = JSON.parse(localStorage.getItem('focusGoals')) || [];
        let settings = JSON.parse(localStorage.getItem('focusSettings')) || {
            notifications: true,
            sound: true,
            vibration: true,
            autoStart: false
        };
        
        // ====================
        // INITIALIZATION
        // ====================
        function initApp() {
            console.log("Initializing Focus Alarm Pro...");
            
            // Load saved data
            loadSettings();
            loadGoals();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check PWA status
            checkPWAStatus();
            
            // Setup periodic checks
            setInterval(checkReminders, 60000); // Check every minute
            setInterval(updateGoalProgress, 10000); // Update progress every 10 seconds
            
            // Initial render
            renderGoals();
            updateStats();
            
            // Show welcome message
            setTimeout(() => {
                showNotification("Welcome!", "Add your first goal to get started!");
            }, 1000);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    requestNotificationPermission();
                }, 2000);
            }
        }
        
        // ====================
        // GOAL MANAGEMENT
        // ====================
        
        // Add new goal
        function addGoal(event) {
            event.preventDefault();
            
            const title = document.getElementById('goalTitle').value.trim();
            const description = document.getElementById('goalDescription').value.trim();
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const sound = document.getElementById('reminderSound').value;
            const frequency = parseInt(document.getElementById('reminderFrequency').value);
            
            // Validation
            if (!title || !startTime || !endTime) {
                showNotification("Error", "Please fill in all required fields");
                return;
            }
            
            if (startTime >= endTime) {
                showNotification("Error", "End time must be after start time");
                return;
            }
            
            // Create goal object
            const goal = {
                id: Date.now(),
                title,
                description,
                startTime,
                endTime,
                sound,
                reminderFrequency: frequency,
                status: 'pending', // pending, active, completed, overdue
                createdAt: new Date().toISOString(),
                startedAt: null,
                completedAt: null,
                lastReminder: null,
                progress: 0
            };
            
            goals.push(goal);
            saveGoals();
            renderGoals();
            
            // Reset form
            document.getElementById('goalForm').reset();
            
            // Show success message
            showNotification("Goal Added!", `"${title}" has been added successfully`);
            
            // Auto-start if it's time
            checkAndAutoStartGoal(goal);
        }
        
        // Start a goal
        function startGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            goal.status = 'active';
            goal.startedAt = new Date().toISOString();
            goal.progress = 0;
            
            saveGoals();
            renderGoals();
            updateStats();
            
            // Play start sound
            if (settings.sound) {
                playSound('bell');
            }
            
            // Vibrate if enabled
            if (settings.vibration && 'vibrate' in navigator) {
                navigator.vibrate([100, 50, 100]);
            }
            
            showNotification("Goal Started!", `Time to focus on "${goal.title}"!`);
        }
        
        // Complete a goal
        function completeGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            goal.status = 'completed';
            goal.completedAt = new Date().toISOString();
            goal.progress = 100;
            
            saveGoals();
            renderGoals();
            updateStats();
            
            // Play completion sound
            if (settings.sound) {
                playSound('success');
            }
            
            // Vibrate if enabled
            if (settings.vibration && 'vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
            
            showNotification("üéâ Goal Completed!", `Great job finishing "${goal.title}"!`);
            
            // Auto-start next goal if enabled
            if (settings.autoStart) {
                autoStartNextGoal();
            }
        }
        
        // Remove a goal
        function removeGoal(goalId) {
            if (!confirm("Are you sure you want to remove this goal?")) return;
            
            goals = goals.filter(g => g.id !== goalId);
            saveGoals();
            renderGoals();
            updateStats();
            
            showNotification("Goal Removed", "Goal has been removed from your list");
        }
        
        // Auto-start next pending goal
        function autoStartNextGoal() {
            const pendingGoals = goals.filter(g => g.status === 'pending');
            if (pendingGoals.length > 0) {
                const nextGoal = pendingGoals[0];
                setTimeout(() => startGoal(nextGoal.id), 1000);
            }
        }
        
        // Check and auto-start goal if it's time
        function checkAndAutoStartGoal(goal) {
            const now = new Date();
            const [goalHour, goalMinute] = goal.startTime.split(':').map(Number);
            const goalTime = new Date();
            goalTime.setHours(goalHour, goalMinute, 0, 0);
            
            // If goal time is within 1 minute, auto-start
            if (Math.abs(goalTime - now) < 60000) {
                setTimeout(() => startGoal(goal.id), 1000);
            }
        }
        
        // ====================
        // REMINDER SYSTEM
        // ====================
        
        function checkReminders() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            goals.forEach(goal => {
                // Check pending goals that should have started
                if (goal.status === 'pending') {
                    const [startHour, startMinute] = goal.startTime.split(':').map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    
                    if (currentTime >= startTimeInMinutes) {
                        // Mark as overdue
                        if (goal.status !== 'overdue') {
                            goal.status = 'overdue';
                            saveGoals();
                            renderGoals();
                        }
                        
                        // Send reminders
                        sendReminder(goal);
                    }
                }
                
                // Check active goals that are ending soon
                if (goal.status === 'active') {
                    const [endHour, endMinute] = goal.endTime.split(':').map(Number);
                    const endTimeInMinutes = endHour * 60 + endMinute;
                    
                    // If 5 minutes left, send warning
                    if (endTimeInMinutes - currentTime === 5) {
                        showNotification("Time Almost Up!", 
                            `Only 5 minutes left for "${goal.title}"!`);
                    }
                    
                    // If time is up, mark as overdue
                    if (currentTime >= endTimeInMinutes) {
                        showNotification("Time's Up!", 
                            `Time for "${goal.title}" has ended. Please mark as complete.`);
                    }
                }
            });
            
            updateStats();
        }
        
        function sendReminder(goal) {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const [startHour, startMinute] = goal.startTime.split(':').map(Number);
            const startTimeInMinutes = startHour * 60 + startMinute;
            
            // Check if enough time has passed since last reminder
            const timeDiff = currentTime - startTimeInMinutes;
            const lastReminder = goal.lastReminder || 0;
            const reminderInterval = goal.reminderFrequency || 5;
            
            if (timeDiff - lastReminder >= reminderInterval) {
                goal.lastReminder = timeDiff;
                saveGoals();
                
                // Focus reminder messages
                const messages = [
                    "FOCUS! You're behind schedule!",
                    "STUDY NOW! Time's running out!",
                    "FOCUS, FOCUS! You need to start!",
                    "STUDY, STUDY! You're out of time!",
                    "ALERT! Start your work NOW!",
                    "Wake up! You should be working!",
                    "Don't procrastinate! Start now!",
                    "Time is money! Get to work!"
                ];
                
                const message = messages[Math.floor(Math.random() * messages.length)];
                
                // Play alarm sound
                if (settings.sound) {
                    playSound(goal.sound || 'focus');
                }
                
                // Vibrate if enabled
                if (settings.vibration && 'vibrate' in navigator) {
                    navigator.vibrate([300, 100, 300, 100, 300]);
                }
                
                // Show notification
                showNotification("‚è∞ FOCUS REMINDER", 
                    `${message}\nGoal: ${goal.title}`);
                
                // Send browser notification
                if (settings.notifications && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification("FOCUS ALARM", {
                        body: `${message}\n${goal.title}`,
                        icon: '/icon-192.png',
                        requireInteraction: true
                    });
                }
            }
        }
        
        // ====================
        // PROGRESS TRACKING
        // ====================
        
        function updateGoalProgress() {
            goals.forEach(goal => {
                if (goal.status === 'active' && goal.startedAt) {
                    const start = new Date(goal.startedAt);
                    const now = new Date();
                    const [endHour, endMinute] = goal.endTime.split(':').map(Number);
                    
                    const endTime = new Date(start);
                    endTime.setHours(endHour, endMinute, 0, 0);
                    
                    const totalDuration = endTime - start;
                    const elapsed = now - start;
                    
                    if (totalDuration > 0) {
                        const progress = Math.min(Math.round((elapsed / totalDuration) * 100), 100);
                        goal.progress = progress;
                    }
                }
            });
            
            saveGoals();
            renderGoals();
        }
        
        // ====================
        // RENDERING
        // ====================
        
        function renderGoals() {
            const container = document.getElementById('goalsList');
            
            if (goals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span>üìù</span>
                        <p>No goals added yet.</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Add your first goal above!</p>
                    </div>
                `;
                return;
            }
            
            // Sort goals: active first, then overdue, then pending, then completed
            const sortedGoals = [...goals].sort((a, b) => {
                const order = { active: 0, overdue: 1, pending: 2, completed: 3 };
                return order[a.status] - order[b.status];
            });
            
            container.innerHTML = sortedGoals.map(goal => {
                const start = formatTime(goal.startTime);
                const end = formatTime(goal.endTime);
                const statusClass = `status-${goal.status}`;
                
                return `
                    <div class="goal-item ${goal.status}" data-id="${goal.id}">
                        <div class="goal-header">
                            <div>
                                <div class="goal-title">${goal.title}</div>
                                <span class="status-badge ${statusClass}">${goal.status.toUpperCase()}</span>
                            </div>
                            <div class="goal-time">${start} - ${end}</div>
                        </div>
                        
                        ${goal.description ? `
                            <div class="goal-description">${goal.description}</div>
                        ` : ''}
                        
                        ${goal.status === 'active' ? `
                            <div class="goal-progress">
                                <div class="progress-bar" style="width: ${goal.progress}%"></div>
                            </div>
                            <div style="text-align: center; font-size: 0.9rem; color: var(--secondary); margin: 5px 0;">
                                ${goal.progress}% complete
                            </div>
                        ` : ''}
                        
                        <div class="goal-actions">
                            ${goal.status === 'pending' ? `
                                <button class="btn btn-success" onclick="startGoal(${goal.id})">
                                    ‚ñ∂Ô∏è Start Now
                                </button>
                            ` : ''}
                            
                            ${goal.status === 'active' ? `
                                <button class="btn btn-primary" onclick="completeGoal(${goal.id})">
                                    ‚úÖ Mark Complete
                                </button>
                            ` : ''}
                            
                            ${goal.status === 'overdue' ? `
                                <button class="btn btn-warning" onclick="startGoal(${goal.id})">
                                    üîÑ Start Anyway
                                </button>
                            ` : ''}
                            
                            ${goal.status === 'completed' ? `
                                <button class="btn btn-secondary" disabled>
                                    ‚úì Completed
                                </button>
                            ` : ''}
                            
                            <button class="btn btn-danger" onclick="removeGoal(${goal.id})">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateStats() {
            const total = goals.length;
            const active = goals.filter(g => g.status === 'active').length;
            const completedToday = goals.filter(g => {
                if (g.status !== 'completed') return false;
                const today = new Date().toDateString();
                return new Date(g.completedAt).toDateString() === today;
            }).length;
            const overdue = goals.filter(g => g.status === 'overdue').length;
            
            document.getElementById('totalGoals').textContent = total;
            document.getElementById('activeGoals').textContent = active;
            document.getElementById('completedToday').textContent = completedToday;
            document.getElementById('overdueGoals').textContent = overdue;
        }
        
        // ====================
        // UTILITIES
        // ====================
        
        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }
        
        function playSound(type) {
            if (!settings.sound) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'focus':
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        break;
                    case 'urgent':
                        oscillator.frequency.value = 1000;
                        oscillator.type = 'square';
                        break;
                    case 'bell':
                        oscillator.frequency.value = 523.25;
                        oscillator.type = 'sine';
                        break;
                    case 'buzzer':
                        oscillator.frequency.value = 400;
                        oscillator.type = 'sawtooth';
                        break;
                    case 'success':
                        oscillator.frequency.value = 523.25;
                        oscillator.type = 'sine';
                        break;
                }
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 1);
            } catch (e) {
                console.log('Audio error:', e);
            }
        }
        
        function showNotification(title, message) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-title">
                    <span>üîî</span> ${title}
                </div>
                <div class="notification-message">${message}</div>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        
        // ====================
        // SETTINGS MANAGEMENT
        // ====================
        
        function loadSettings() {
            // Load from localStorage
            const saved = JSON.parse(localStorage.getItem('focusSettings'));
            if (saved) {
                settings = saved;
            }
            
            // Update UI
            document.getElementById('notificationsEnabled').checked = settings.notifications;
            document.getElementById('soundEnabled').checked = settings.sound;
            document.getElementById('vibrationEnabled').checked = settings.vibration;
            document.getElementById('autoStartEnabled').checked = settings.autoStart;
        }
        
        function saveSettings() {
            settings = {
                notifications: document.getElementById('notificationsEnabled').checked,
                sound: document.getElementById('soundEnabled').checked,
                vibration: document.getElementById('vibrationEnabled').checked,
                autoStart: document.getElementById('autoStartEnabled').checked
            };
            
            localStorage.setItem('focusSettings', JSON.stringify(settings));
        }
        
        // ====================
        // DATA PERSISTENCE
        // ====================
        
        function saveGoals() {
            localStorage.setItem('focusGoals', JSON.stringify(goals));
        }
        
        function loadGoals() {
            const saved = JSON.parse(localStorage.getItem('focusGoals'));
            if (saved) {
                goals = saved;
            }
        }
        
        // ====================
        // CLEAR FUNCTIONS
        // ====================
        
        function clearCompletedGoals() {
            if (!confirm("Remove all completed goals?")) return;
            
            goals = goals.filter(g => g.status !== 'completed');
            saveGoals();
            renderGoals();
            updateStats();
            
            showNotification("Cleaned Up", "All completed goals have been removed");
        }
        
        function clearAllGoals() {
            if (!confirm("‚ö†Ô∏è Delete ALL goals? This cannot be undone.")) return;
            
            goals = [];
            saveGoals();
            renderGoals();
            updateStats();
            
            showNotification("All Goals Cleared", "Your goal list is now empty");
        }
        
        // ====================
        // PWA FUNCTIONALITY
        // ====================
        
        function checkPWAStatus() {
            const isPWA = window.matchMedia('(display-mode: standalone)').matches;
            const canVibrate = 'vibrate' in navigator;
            
            let statusText = '';
            if (isPWA) {
                statusText = '‚úÖ Installed as PWA';
                if (canVibrate) {
                    statusText += ' | üì≥ Vibration Ready';
                }
            } else {
                statusText = 'üì± Add to Home Screen for full features';
            }
            
            document.getElementById('vibrationStatusText').textContent = statusText;
            
            // Show install button if not PWA
            if (!isPWA) {
                document.getElementById('installContainer').style.display = 'block';
            }
        }
        
        // ====================
        // EVENT LISTENERS
        // ====================
        
        function setupEventListeners() {
            // Goal form
            document.getElementById('goalForm').addEventListener('submit', addGoal);
            
            // Settings toggles
            document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                toggle.addEventListener('change', saveSettings);
            });
            
            // Install button
            document.getElementById('installButton').addEventListener('click', () => {
                showNotification("Install Instructions", 
                    "1. Tap Chrome menu (‚ãÆ)\n" +
                    "2. Select 'Add to Home screen'\n" +
                    "3. Open from home screen");
            });
            
            // Before install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredPrompt = e;
                
                document.getElementById('installButton').addEventListener('click', async () => {
                    if (window.deferredPrompt) {
                        window.deferredPrompt.prompt();
                        const { outcome } = await window.deferredPrompt.userChoice;
                        console.log(`User response: ${outcome}`);
                        window.deferredPrompt = null;
                    }
                });
            });
        }
        
        // ====================
        // PUBLIC FUNCTIONS
        // ====================
        
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        settings.notifications = true;
                        saveSettings();
                        showNotification("Notifications Enabled", 
                            "You'll receive browser notifications for reminders!");
                    }
                });
            } else if (Notification.permission === 'granted') {
                showNotification("Already Enabled", 
                    "Notifications are already enabled!");
            }
        }
        
        function testAlarm() {
            // Play test sound
            playSound('focus');
            
            // Vibrate if enabled
            if (settings.vibration && 'vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            showNotification("Test Alarm", 
                "If you heard a sound and/or felt vibration, your alarm is working!");
        }
        
        // ====================
        // INITIALIZE APP
        // ====================
        
        window.addEventListener('DOMContentLoaded', initApp);
        
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        
        // Export functions for HTML onclick
        window.startGoal = startGoal;
        window.completeGoal = completeGoal;
        window.removeGoal = removeGoal;
        window.clearCompletedGoals = clearCompletedGoals;
        window.clearAllGoals = clearAllGoals;
        window.requestNotificationPermission = requestNotificationPermission;
        window.testAlarm = testAlarm;
    </script>
</body>
</html>